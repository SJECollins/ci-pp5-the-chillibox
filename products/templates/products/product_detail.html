{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}
{{ product.name }}
{% endblock %}

{% block content %}
<section class="container-fluid">
    <div class="mt-4">
        <!-- Link to return to products (and product dashboard for admin)-->
        <a class="chilli-link big" href="{% url 'products:latest' %}">&laquo; To Latest
            Products</a><br>
        <a class="chilli-link big" href="{% url 'products:category' product.category.slug %}">&laquo; To {{ product.category }}</a>
        <!-- Link for staff to management dashboard-->
        {% if user.is_staff %}
        <a class="chilli-link float-end" href="{% url 'management:dashboard' %}">Go To Dashboard &raquo;</a>
        {% endif %}
    </div>
    <div class="row m-4">
        <!-- Product image and description -->
        <div class="col-lg-6 text-center">
            <div>
                <h1 class="headings">{{ product.name }}</h1>
            </div>
            {% if product.image %}
            <div>
                <img class="pics pics-lg" src="{{ product.image.url }}">
            </div>
            {% endif %}
            <p class="m-5 text-start">{{ product.description }}</p>
            {% if user.is_staff %}
                <!-- Edit and Delete for admin -->
                <a class="chilli-btn" href="{% url 'management:edit_product' product.pk %}">Edit Product</a>
                <a class="chilli-btn chilli-dngr" href="{% url 'management:delete_product' product.pk %}">Delete Product</a>
            {% endif %}
        </div>
        <div class="col-lg-6 d-flex flex-column">
            <!-- Table for product details -->
            <div class="order-2 order-lg-1">
                <h2 class="headings headings-sm">{{ product.name }} Details:</h2>
                <table class="table table-borderless">
                    <tr>
                        <th>Category: </th>
                        <td>{{ product.category }}</td>
                    </tr>
                    <tr>
                        <th>SubCategory: </th>
                        <td>{{ product.subcategory }}</td>
                    </tr>
                    <tr>
                        {% if product.growth_time %}
                        <th>Growth time to maturity: </th>
                        <td>{{ product.growth_time }}</td>
                        {% endif %}
                    </tr>
                    <tr>
                        {% if product.heat_level %}
                        <th>Heat: </th>
                        <td>{{ product.heat_level }}</td>
                        {% endif %}
                    </tr>
                    <tr>
                        {% if product.ingredients %}
                        <th>Ingredients: </th>
                        <td>{{ product.ingredients }}</td>
                        {% endif %}
                    </tr>
                    {% if product.variants %}
                    <tr>
                        <th>Options: </th>
                        <td>
                            {% for variant in product.variants.all %}
                            <p class="mb-0">{{ variant.size }} - €{{ variant.price }}</p>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endif %}
                    {% if product.box_contents.all %}
                    <tr>
                        <th class="align-top">Contents: </th>
                        <td>{% for content in product.box_contents.all %}<p class="m-0">{{ content.name }}</p>
                            {% endfor %}</td>
                    </tr>
                    {% endif %}
                    {% if avg_rating.rounded is not None %}
                    <tr>
                        <th>Avg. Rating: </th>
                        <td>{% if avg_rating.rounded == 1 %}
                            <img width="33" height="80" class="rate-pics" src="{% static 'images/rate1.png' %}">
                            {% elif avg_rating.rounded == 2 %}
                            <img width="63" height="80" class="rate-pics" src="{% static 'images/rate2.png' %}">
                            {% elif avg_rating.rounded == 3 %}
                            <img width="93" height="80" class="rate-pics" src="{% static 'images/rate3.png' %}">
                            {% elif avg_rating.rounded == 4 %}
                            <img width="124" height="80" class="rate-pics" src="{% static 'images/rate4.png' %}">
                            {% else %}
                            <img width="154" height="80" class="rate-pics" src="{% static 'images/rate5.png' %}">
                            {% endif %}
                            <strong>/</strong>
                            <img width="154" height="80" class="rate-pics" src="{% static 'images/rate5.png' %}">
                        </td>
                    </tr>
                    {% endif %}
                </table>
            </div>
            <div class="order-1 order-lg-2">
                <h3 class="headings big">Add To Cart:</h3>
                <form action="{% url 'cart:add_to_cart' product.id %}" method="POST">
                    {% csrf_token %}
                    <div>
                        <label class="me-4"><strong>Select Options:</strong></label>
                        <select id="prices" name="product_variant" id="product_variant" class="border rounded-3" data-hx-get="/products/current_stock/" data-hx-target="#current_stock">
                            <option value="default">Please select an option...</option>
                            {% for variant in product.variants.all %}
                            <option data-variant_id="{{ variant.id }}" value="{{ variant.id }}">{{ variant.size }}
                                €{{ variant.price }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <p><strong>Stock: </strong> <span id="current_stock"></span></p>
                    <div class="my-3">
                        <label class="me-4"><strong>Select Quantity: </strong></label>
                        <div id="change_qty" class="d-inline">
                            <button type="button" id="dec_qty" class="chilli-btn">-</button>
                            <input class="text-center" data-item_id="{{ product.id }}" name="quantity" id="product_qty"
                                type="number" value="1" min="0" max="99">
                            <button type="button" id="inc_qty" class="chilli-btn">+</button>
                            <p id="qty_warning"><em>No more available</em></p>
                        </div>
                    </div>
                    <button id="add" class="chilli-btn my-2 d-block" type="submit" disabled>Add To Cart</button>
                </form>
                {% for item in cart_items %}
                    {% if forloop.first %}
                        {% if product.id == item.product.id %}
                            <p class="small">{{ product }} already in cart.</p>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <h1 class="headings">Reviews</h1>
            {% if reviewed %}
            <p><strong>Thank you for your review! If you'd like to get in touch with any concerns, please visit our <a
                        class="chilli-link" href="{% url 'home:contact' %}">contact page</a>.</strong></p>
            {% else %}
            <h3>Write a review for {{ product }}:</h3>
            <p><strong>Or if you would like to get in touch with any concerns, please visit our <a
                class="chilli-link" href="{% url 'home:contact' %}">contact page</a>.</strong></p>
            <form class="col-lg-4 mb-5" method="post">
                {% csrf_token %}
                {{ review_form | crispy }}
                <p>Posting as: {% if user.is_authenticated %}{{ user }}{% else %}Anonymous{% endif %}</p>
                <button type="submit" class="chilli-btn">Submit</button>
            </form>
            {% endif %}
            <div class="row">
                {% for review in reviews %}
                <div class="card col-sm-6 col-md-4 mb-3">
                    <h2 class="headings big">
                        {% if review.reviewer is not None %}{{ review.reviewer.display_name }}{% else %}Anonymous{% endif %} <span
                            class="small">on {{ review.added_on|date:'d/m/y' }}</span></h2>
                    <p>{{ review }}</p>
                    <p><strong>Rating: </strong>
                        {% if review.rating == 1 %}
                        <img width="33" height="80" class="rate-pics" src="{% static 'images/rate1.png' %}">
                        {% elif review.rating == 2 %}
                        <img width="63" height="80" class="rate-pics" src="{% static 'images/rate2.png' %}">
                        {% elif review.rating == 3 %}
                        <img width="93" height="80" class="rate-pics" src="{% static 'images/rate3.png' %}">
                        {% elif review.rating == 4 %}
                        <img width="124" height="80" class="rate-pics" src="{% static 'images/rate4.png' %}">
                        {% else %}
                        <img width="154" height="80" class="rate-pics" src="{% static 'images/rate5.png' %}">
                        {% endif %}
                    </p>
                        <div class="d-flex flex-row justify-content-between my-2">
                            {% if user.userprofile == review.reviewer %}
                                <a class="chilli-btn chilli-go" href="{% url 'profiles:edit_review' review.pk %}">Edit Review</a>
                            {% endif %}
                            {% if user.is_staff %}
                                <a class="chilli-btn chilli-dngr" href="{% url 'management:remove_review' review.pk %}">Delete Review</a>
                            {% endif %}
                        </div>
                </div>
                {% empty %}
                <p><strong>No reviews yet. Be the first to write one!</strong></p>
                {% endfor %}
            </div>
        </div>
    </div>
</section>

<script type="text/javascript">
document.addEventListener("DOMContentLoaded", () => {
    console.log("updated")
    const quantity = document.getElementById("product_qty")
    const decrease = document.getElementById("dec_qty")
    const increase = document.getElementById("inc_qty")
    const prices = document.getElementById("prices")
    const addBtn = document.getElementById("add")
    const warning = document.getElementById("qty_warning")
    const stock = document.getElementById("current_stock")

    // Mutation Observer for stock - https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver
    // FIVE HOURS TO FIND A SOLUTION NOT INVOLVING jQuery
    const config = { childList: true }
    const callback = (mutationList, observer) => {
        for (const mutation of mutationList) {
            if (mutation.type === 'childList') {
                console.log("childList")
                updateStock()
                } else {
                console.log(mutation.type)
            }
        }
    }
    const observer = new MutationObserver(callback)
    observer.observe(stock, config)

    prices.addEventListener("change", changeAddBtn)

    function changeAddBtn() {
        if (prices.value == "default") {
            addBtn.disabled = true
        } else {
            addBtn.disabled = false
        }
    }

    decrease.addEventListener("click", decQty)
    increase.addEventListener("click", incQty)

    let qty = Number(quantity.value)
    let currentStock
    console.log(currentStock)
    console.log(qty)

    function updateStock() {
        currentStock = stock.textContent
        console.log(currentStock)
    }
    console.log(currentStock)

    if (currentStock == 0) {
        quantity.value = 0
        warning.style.display = "block"
    } else {
        warning.style.display = "none"
    }

    function decQty() {
        if (qty > 1) {
            qty--
            quantity.value = qty
        }
        if (qty < currentStock || qty == 99) {
            warning.style.display = "none"
        }
    }

    function incQty() {
        if (qty < currentStock && qty < 99) {
            qty++
            quantity.value = qty
            console.log(qty)
            console.log('click')
            console.log(currentStock)
        }
        if (qty == currentStock || qty == 99) {
            warning.style.display = "block"
        }
    }
})
</script>
{% endblock %}